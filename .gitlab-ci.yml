stages:
  - build
  - test
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository
    - backend/target

# Build stage - Build all Docker images
build-backend:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd backend
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

build-docker-images:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    # Build frontend image
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/frontend:latest ./frontend
    
    # Build backend image
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/backend:latest ./backend
    
    # Build database image (if custom Dockerfile exists)
    - |
      if [ -f "./database/Dockerfile" ]; then
        docker build -t $CI_REGISTRY_IMAGE/database:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/database:latest ./database
      fi
    
    # Save images as artifacts for later stages
    - docker save $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA > frontend-image.tar
    - docker save $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA > backend-image.tar
  artifacts:
    paths:
      - frontend-image.tar
      - backend-image.tar
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# Test stage - Run unit and integration tests
test-unit:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  services:
    - mysql:8.0
  variables:
    MYSQL_ROOT_PASSWORD: testpassword
    MYSQL_DATABASE: ecommerce_test
    DB_HOST: mysql
    DB_PORT: "3306"
    DB_NAME: ecommerce_test
    DB_USER: root
    DB_PASSWORD: testpassword
  script:
    - cd backend
    - mvn $MAVEN_CLI_OPTS test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - backend/target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: backend/target/site/jacoco/jacoco.xml
    paths:
      - backend/target/site/jacoco/
      - backend/target/surefire-reports/
    expire_in: 30 days
  only:
    - main
    - develop
    - merge_requests

test-integration:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apt-get update && apt-get install -y docker.io
  script:
    - cd backend
    # Run integration tests with TestContainers
    - mvn $MAVEN_CLI_OPTS verify -Dtest=*IntegrationTest,*PropertyTest
  artifacts:
    when: always
    reports:
      junit:
        - backend/target/surefire-reports/TEST-*.xml
    paths:
      - backend/target/surefire-reports/
    expire_in: 30 days
  only:
    - main
    - develop
    - merge_requests

# Push stage - Push images to registry
push-images:
  stage: push
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - build-docker-images
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Load images from artifacts
    - docker load < frontend-image.tar
    - docker load < backend-image.tar
    
    # Push images with commit SHA tag
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    
    # Push latest tag only for main branch
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker push $CI_REGISTRY_IMAGE/frontend:latest
        docker push $CI_REGISTRY_IMAGE/backend:latest
      fi
  only:
    - main
    - develop

# Deploy stage - Manual deployment trigger
deploy-staging:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - apk add --no-cache docker-compose
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Deploying to staging environment..."
    - docker-compose -f docker-compose.yml pull
    - docker-compose -f docker-compose.yml up -d
    - echo "Waiting for services to be healthy..."
    - sleep 30
    - docker-compose -f docker-compose.yml ps
    # Run smoke tests
    - |
      echo "Running smoke tests..."
      curl -f http://localhost:80 || exit 1
      curl -f http://localhost:8080/actuator/health || exit 1
      echo "Smoke tests passed!"
  environment:
    name: staging
    url: http://staging.example.com
  when: manual
  only:
    - develop

deploy-production:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - apk add --no-cache docker-compose
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Deploying to production environment..."
    - docker-compose -f docker-compose.yml pull
    - docker-compose -f docker-compose.yml up -d
    - echo "Waiting for services to be healthy..."
    - sleep 30
    - docker-compose -f docker-compose.yml ps
    # Run smoke tests
    - |
      echo "Running smoke tests..."
      curl -f http://localhost:80 || exit 1
      curl -f http://localhost:8080/actuator/health || exit 1
      echo "Smoke tests passed!"
  environment:
    name: production
    url: http://production.example.com
  when: manual
  only:
    - main

# Notification job for test failures
notify-failure:
  stage: .post
  image: alpine:latest
  script:
    - echo "Pipeline failed! Sending notification..."
    - |
      # Example: Send notification via webhook
      # curl -X POST -H 'Content-type: application/json' \
      #   --data "{\"text\":\"Pipeline $CI_PIPELINE_ID failed for $CI_COMMIT_REF_NAME\"}" \
      #   $SLACK_WEBHOOK_URL
    - echo "Notification sent (configure webhook URL in CI/CD variables)"
  when: on_failure
  only:
    - main
    - develop
