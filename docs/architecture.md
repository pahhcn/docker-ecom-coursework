# 架构文档

## 目录
1. [系统概述](#系统概述)
2. [架构图](#架构图)
3. [组件详情](#组件详情)
4. [数据流](#数据流)
5. [网络架构](#网络架构)
6. [技术栈](#技术栈)
7. [设计决策](#设计决策)

## 系统概述

Docker 电商数据管理系统是一个容器化的三层 Web 应用，展示了现代 DevOps 实践和容器编排。该系统提供了完整的产品目录管理解决方案，包括 Web 界面、RESTful API 和持久化数据库存储。

### 主要功能

- **容器化架构**：所有组件都在 Docker 容器中运行，确保一致性和可移植性
- **服务编排**：Docker Compose 管理多容器部署
- **持久化存储**：Docker 卷确保数据在容器重启后保留
- **健康监控**：所有服务都内置健康检查
- **CI/CD 集成**：自动化构建、测试和部署流水线
- **基于属性的测试**：通过形式化属性验证正确性

### 系统目标

1. **展示 Docker 熟练度**：展示 Dockerfile 创建、镜像优化和容器管理
2. **实施最佳实践**：遵循容器化和 DevOps 的行业标准
3. **确保正确性**：使用基于属性的测试验证系统行为
4. **实现可扩展性**：设计支持水平扩展和云部署

## 架构图

### 高层系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         主机                                     │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              Docker 自定义网络                              │ │
│  │              (ecommerce-network)                            │ │
│  │                                                              │ │
│  │  ┌──────────────┐      ┌──────────────┐      ┌──────────┐ │ │
│  │  │   前端       │─────▶│   后端       │─────▶│  MySQL   │ │ │
│  │  │   (Nginx)    │      │(Spring Boot) │      │ 数据库   │ │ │
│  │  │              │      │              │      │          │ │ │
│  │  │  端口: 80    │      │  端口: 8080  │      │端口: 3306│ │ │
│  │  │  CPU: 0.5    │      │  CPU: 1.0    │      │CPU: 1.0  │ │ │
│  │  │  RAM: 256MB  │      │  RAM: 512MB  │      │RAM: 1GB  │ │ │
│  │  └──────────────┘      └──────────────┘      └──────────┘ │ │
│  │                                                              │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              Docker 卷                                      │ │
│  │  - mysql-data（持久化数据库存储）                          │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 服务依赖图

```
┌──────────────────────────────────────────────────────────┐
│                    服务依赖关系                           │
└──────────────────────────────────────────────────────────┘

    ┌──────────┐
    │ 数据库   │  （首先启动）
    │  MySQL   │
    └────┬─────┘
         │
         │ depends_on + health_check
         │
    ┌────▼─────┐
    │ 后端     │  （数据库健康后启动）
    │  Spring  │
    └────┬─────┘
         │
         │ depends_on + health_check
         │
    ┌────▼─────┐
    │ 前端     │  （后端健康后启动）
    │  Nginx   │
    └──────────┘
```

### 数据流图

```
┌─────────────────────────────────────────────────────────────┐
│                      数据流                                  │
└─────────────────────────────────────────────────────────────┘

用户浏览器
     │
     │ HTTP 请求（端口 80）
     ▼
┌─────────────┐
│  前端       │
│   (Nginx)   │
│             │
│ - 提供      │
│   HTML/CSS/ │
│   JS        │
│ - 代理      │
│   /api/*    │
└──────┬──────┘
       │
       │ HTTP 请求到 /api/products
       │ （代理到 backend:8080）
       ▼
┌─────────────┐
│  后端       │
│ (Spring     │
│  Boot)      │
│             │
│ - REST API  │
│ - 业务逻辑  │
│ - JPA/      │
│   Hibernate │
└──────┬──────┘
       │
       │ JDBC 连接
       │ (mysql:3306)
       ▼
┌─────────────┐
│  数据库     │
│  (MySQL)    │
│             │
│ - Products  │
│   表        │
│ - 持久化    │
│   存储      │
└─────────────┘
```

### 网络架构

```
┌─────────────────────────────────────────────────────────────┐
│              Docker 网络: ecommerce-network                  │
│                    （桥接驱动）                              │
└─────────────────────────────────────────────────────────────┘

内部网络（172.18.0.0/16）
├── frontend（172.18.0.2）
│   ├── 主机名: frontend
│   ├── 别名: ecommerce-frontend
│   └── 暴露: 80 → 主机:80
│
├── backend（172.18.0.3）
│   ├── 主机名: backend
│   ├── 别名: ecommerce-backend
│   └── 暴露: 8080 → 主机:8080
│
└── mysql（172.18.0.4）
    ├── 主机名: mysql, database
    ├── 别名: ecommerce-database
    └── 暴露: 3306 → 主机:3306

服务发现：
- 服务使用主机名通信（例如 backend:8080）
- DNS 解析由 Docker 处理
- 无硬编码 IP 地址
```

## 组件详情

### 前端服务

**目的**：提供静态网页并代理 API 请求

**技术**：Nginx Alpine

**职责**：
- 提供 HTML、CSS 和 JavaScript 文件
- 将 `/api/*` 请求代理到后端服务
- 提供健康检查端点
- 处理静态资源缓存

**配置**：
- 基础镜像：`nginx:alpine`（~40MB）
- 暴露端口：80
- 健康检查：每 30 秒检查 `/health` 端点
- 资源限制：0.5 CPU，256MB RAM

**关键文件**：
- `frontend/Dockerfile`：多阶段构建配置
- `frontend/nginx.conf`：Nginx 服务器配置
- `frontend/html/`：静态 Web 资源

### 后端服务

**目的**：为产品管理提供 RESTful API

**技术**：Spring Boot 3.x with Java 17

**职责**：
- 处理 CRUD 操作的 HTTP 请求
- 实现业务逻辑
- 管理数据库连接
- 提供健康检查端点
- 验证输入数据

**配置**：
- 基础镜像：`eclipse-temurin:17-jre-alpine`（~180MB）
- 暴露端口：8080
- 健康检查：每 30 秒检查 `/actuator/health` 端点
- 资源限制：1.0 CPU，512MB RAM

**关键组件**：
- **控制器层**：REST 端点（`ProductController`）
- **服务层**：业务逻辑（`ProductService`）
- **仓库层**：数据访问（`ProductRepository`）
- **模型层**：领域实体（`Product`）

**关键文件**：
- `backend/Dockerfile`：使用 Maven 的多阶段构建
- `backend/pom.xml`：Maven 依赖
- `backend/src/main/`：应用源代码
- `backend/src/test/`：测试套件

### 数据库服务

**目的**：产品数据的持久化存储

**技术**：MySQL 8.0

**职责**：
- 存储产品信息
- 提供 ACID 事务
- 处理并发连接
- 在重启后持久化数据

**配置**：
- 基础镜像：`mysql:8.0`（~500MB）
- 暴露端口：3306
- 健康检查：每 10 秒执行 `mysqladmin ping`
- 资源限制：1.0 CPU，1GB RAM
- 卷：`mysql-data` 挂载在 `/var/lib/mysql`

**模式**：
- **products** 表，包含 9 列
- 在 `category` 和 `name` 上建立索引以提高性能
- UTF-8（utf8mb4）字符编码
- created_at 和 updated_at 的自动时间戳

**关键文件**：
- `database/Dockerfile`：MySQL 配置
- `database/init.sql`：模式和种子数据

## 数据流

### 产品检索流程

1. **用户请求**：用户打开浏览器并导航到 `http://localhost`
2. **前端提供页面**：Nginx 提供 `index.html`
3. **JavaScript 加载**：浏览器执行 `app.js`
4. **API 请求**：JavaScript 向 `/api/products` 发起 GET 请求
5. **Nginx 代理**：Nginx 将请求转发到 `http://backend:8080/api/products`
6. **后端处理**：Spring Boot 控制器接收请求
7. **服务层**：ProductService 调用 ProductRepository
8. **数据库查询**：JPA/Hibernate 执行 SQL 查询
9. **MySQL 响应**：数据库返回产品行
10. **JSON 序列化**：Spring Boot 将实体转换为 JSON
11. **HTTP 响应**：后端返回 JSON 数组
12. **前端渲染**：JavaScript 在 HTML 中渲染产品

### 产品创建流程

1. **用户输入**：用户填写产品表单并点击提交
2. **JavaScript 验证**：客户端验证检查必填字段
3. **API 请求**：JavaScript 向 `/api/products` 发起带 JSON 正文的 POST 请求
4. **Nginx 代理**：Nginx 将请求转发到后端
5. **后端验证**：Spring Boot 验证请求正文
6. **服务层**：ProductService 处理创建逻辑
7. **数据库插入**：JPA/Hibernate 执行 INSERT 语句
8. **MySQL 存储**：数据库存储新产品行
9. **响应生成**：后端返回带 ID 的已创建产品
10. **前端更新**：JavaScript 将新产品添加到显示中

## 网络架构

### Docker 网络配置

**网络名称**：`ecommerce-network`

**网络类型**：桥接（默认）

**子网**：由 Docker 自动分配（通常为 172.18.0.0/16）

**DNS 解析**：Docker 为服务名称解析提供内置 DNS

### 服务通信

**前端 → 后端**：
- 协议：HTTP
- URL：`http://backend:8080/api/products`
- 方法：通过 Docker DNS 进行服务名称解析

**后端 → 数据库**：
- 协议：MySQL 协议（TCP）
- URL：`jdbc:mysql://mysql:3306/ecommerce`
- 方法：通过 Docker DNS 进行服务名称解析

**外部 → 前端**：
- 协议：HTTP
- URL：`http://localhost:80`
- 方法：端口映射（主机:80 → 容器:80）

### 端口映射

| 服务 | 容器端口 | 主机端口 | 目的 |
|------|----------|----------|------|
| 前端 | 80 | 80 | Web 界面 |
| 后端 | 8080 | 8080 | API 访问 |
| 数据库 | 3306 | 3306 | 直接数据库访问（仅开发） |

### 网络安全

**隔离**：默认情况下，服务与主机网络隔离

**内部通信**：服务在内部网络上通信，无需暴露端口

**暴露端口**：仅将必要的端口映射到主机

**生产注意事项**：
- 在生产环境中删除数据库端口映射
- 对外部通信使用 TLS/SSL
- 实施 API 网关以增强安全性

## 技术栈

### 前端技术栈

| 技术 | 版本 | 目的 |
|------|------|------|
| Nginx | Alpine | Web 服务器 |
| HTML5 | - | 页面结构 |
| CSS3 | - | 样式 |
| JavaScript | ES6+ | 客户端逻辑 |

### 后端技术栈

| 技术 | 版本 | 目的 |
|------|------|------|
| Java | 17 | 编程语言 |
| Spring Boot | 3.x | 应用框架 |
| Spring Data JPA | 3.x | 数据访问 |
| Hibernate | 6.x | ORM |
| Maven | 3.9 | 构建工具 |
| Spring Boot Actuator | 3.x | 健康检查 |

### 数据库技术栈

| 技术 | 版本 | 目的 |
|------|------|------|
| MySQL | 8.0 | 关系数据库 |
| InnoDB | - | 存储引擎 |

### DevOps 技术栈

| 技术 | 版本 | 目的 |
|------|------|------|
| Docker | 20.10+ | 容器化 |
| Docker Compose | 2.0+ | 编排 |
| GitLab CI | - | CI/CD 流水线 |
| Jenkins | 2.400+ | CI/CD 流水线 |
| GitHub Actions | - | CI/CD 流水线 |

### 测试技术栈

| 技术 | 版本 | 目的 |
|------|------|------|
| JUnit | 5 | 单元测试 |
| jqwik | 1.8+ | 基于属性的测试 |
| TestContainers | 1.19+ | 集成测试 |
| Mockito | 5.x | 模拟 |
| JaCoCo | 0.8.11 | 代码覆盖率 |

## 设计决策

### 为什么选择 Docker？

**一致性**：开发、测试和生产环境相同

**隔离**：每个服务在自己的容器中运行，具有专用资源

**可移植性**：容器可在任何安装了 Docker 的地方运行

**可扩展性**：易于水平扩展服务

### 为什么选择多阶段构建？

**更小的镜像**：最终镜像中不包含构建工具

**更快的部署**：更小的镜像传输更快

**安全性**：更少的组件意味着更小的攻击面

**层缓存**：依赖项与源代码分开缓存

### 为什么选择 Docker Compose？

**简单性**：单个命令启动整个系统

**配置即代码**：基础设施在 YAML 中定义

**开发效率**：易于启动和拆除环境

**服务依赖**：使用健康检查自动启动排序

### 为什么选择 Spring Boot？

**快速开发**：约定优于配置

**生产就绪**：内置健康检查、指标和监控

**生态系统**：丰富的库和工具生态系统

**JPA 集成**：简化的数据库访问

### 为什么选择 MySQL？

**可靠性**：在生产环境中经过验证

**性能**：针对读密集型工作负载进行优化

**兼容性**：跨平台和工具的广泛支持

**Docker 支持**：官方 Docker 镜像，文档完善

### 为什么选择基于属性的测试？

**正确性验证**：在许多输入上测试属性

**错误发现**：发现开发人员可能遗漏的边缘情况

**规范**：属性作为可执行规范

**信心**：每个属性 100+ 次迭代提供高信心

### 为什么选择 Nginx？

**性能**：高效的静态文件服务

**轻量级**：占用空间小，尤其是 Alpine 版本

**反向代理**：内置 API 路由代理功能

**生产就绪**：在生产环境中经过实战检验

## 可扩展性考虑

### 水平扩展

**前端**：可以在负载均衡器后运行多个副本

**后端**：无状态设计允许多个实例

**数据库**：需要读副本或分片进行水平扩展

### 垂直扩展

**资源限制**：在 docker-compose.yml 中易于调整

**JVM 调优**：后端配置为使用容器内存限制

**数据库调优**：MySQL 配置针对可用资源进行优化

### 云部署

**Kubernetes**：在 `k8s/` 目录中提供清单

**容器仓库**：镜像可以推送到任何仓库

**托管服务**：可以用云数据库服务替换 MySQL

## 监控和可观测性

### 健康检查

**目的**：验证服务可用性

**实现**：Docker HEALTHCHECK 指令

**端点**：
- 前端：`GET /health`
- 后端：`GET /actuator/health`
- 数据库：`mysqladmin ping`

### 日志记录

**策略**：所有日志输出到 stdout/stderr

**收集**：Docker 日志驱动程序

**聚合**：可以与 ELK 堆栈或类似工具集成

### 指标

**后端指标**：Spring Boot Actuator 提供 JVM 和应用指标

**容器指标**：Docker stats API 提供资源使用情况

**APM 集成**：可以集成 Prometheus、Grafana 或 SkyWalking

## 安全考虑

### 容器安全

**非 root 用户**：后端以非特权用户运行

**最小镜像**：基于 Alpine 的镜像减少攻击面

**镜像扫描**：CI/CD 流水线可以集成漏洞扫描

**只读文件系统**：可以启用以增强安全性

### 网络安全

**内部网络**：服务在隔离网络上通信

**端口暴露**：仅将必要的端口暴露给主机

**TLS/SSL**：生产部署应启用

### 秘密管理

**开发**：docker-compose.yml 中的环境变量

**生产**：应使用 Docker secrets 或外部秘密管理器

**无硬编码**：凭证永远不会提交到仓库

## 未来增强

### 计划改进

1. **服务网格**：实施 Istio 进行高级流量管理
2. **缓存层**：添加 Redis 以提高性能
3. **消息队列**：添加 RabbitMQ 进行异步处理
4. **API 网关**：实施 Kong 或类似工具进行集中式 API 管理
5. **分布式追踪**：添加 Jaeger 进行请求追踪
6. **自动扩展**：实施 Kubernetes HPA 进行自动扩展

### 架构演进

**微服务**：将后端拆分为更小、更专注的服务

**事件驱动**：使用消息队列转向事件驱动架构

**CQRS**：分离读写模型以获得更好的可扩展性

**GraphQL**：在 REST 之外添加 GraphQL API

## 参考资料

- [Docker 文档](https://docs.docker.com/)
- [Docker Compose 文档](https://docs.docker.com/compose/)
- [Spring Boot 文档](https://spring.io/projects/spring-boot)
- [MySQL 文档](https://dev.mysql.com/doc/)
- [Nginx 文档](https://nginx.org/en/docs/)
- [12-Factor App 方法论](https://12factor.net/)
